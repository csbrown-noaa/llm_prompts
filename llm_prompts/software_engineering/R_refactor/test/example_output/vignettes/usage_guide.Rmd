---
title: "Usage Guide: Fish Abundance Analysis"
output: html_document
date: '2025-07-08'
---

```{r setup, include=FALSE}
# This code was generated by Gemini on 2025-07-08 as a fork of the
# original repo at [https://example.com/example_analysis](https://example.com/example_analysis)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Introduction

This document demonstrates the refactored workflow for analyzing fish abundance data. The original script was modularized into a series of functions to improve readability and reuse. This guide uses small, self-contained example datasets to walk through the process from data loading to final visualization.

## 1. Setup

First, we load the necessary packages and the custom functions written for this analysis.

```{r load_code}
library(here)
library(ggplot2)
library(dplyr)

# Source all functions from the R/ directory
lapply(list.files(here("R"), pattern = "\\.R$", full.names = TRUE), source)
```

## 2. Configuration

We define the paths to our **example data** and the species we want to analyze.

```{r config}
# Paths to the self-contained example data
station_info_path <- here("inst", "extdata", "mock_station_info.csv")
catch_data_path <- here("inst", "extdata", "mock_catch_data.csv")

# Species to analyze
species_list <- c(
  "Red Snapper" = "Lutjanus campechanus",
  "Gag Grouper" = "Mycteroperca microlepis"
)
```

## 3. Data Loading and Processing

Next, we load the station and catch data using our helper functions. `load_catch_data` correctly assigns column names to the header-less catch file.

```{r load_data}
station_info <- read.csv(station_info_path)
catch_data <- load_catch_data(
  filepath = catch_data_path,
  col_names = c("station_id", "species_name", "catch_count")
)

# Display the loaded data
knitr::kable(station_info, caption = "Mock Station Info")
knitr::kable(catch_data, caption = "Mock Catch Data")
```

Now, we merge the datasets and calculate the catch densities.

```{r process_data}
analysis_data <- calculate_densities(
  station_df = station_info,
  catch_df = catch_data
)

knitr::kable(analysis_data, caption = "Processed Analysis Data")
```

## 4. Modeling and Prediction

We loop through our species list, fitting a model and generating predictions for each one. The model summaries are printed to the console.

```{r model_and_predict}
all_predictions <- lapply(names(species_list), function(species_common_name) {
  
  species_scientific_name <- species_list[[species_common_name]]
  species_data <- analysis_data[analysis_data$species_name == species_scientific_name, ]
  
  # Fit model
  species_model <- fit_species_model(
    species_df = species_data,
    formula = catch_count ~ bottom_temp_c
  )
  
  # Print summary
  cat(paste("---", species_common_name, "Model Summary ---\n"))
  print(summary(species_model))
  
  # Generate predictions
  generate_predictions(
    model = species_model,
    species_df = species_data,
    species_name = species_scientific_name,
    temp_var = "bottom_temp_c"
  )
})

# Combine into one data frame
final_predictions <- bind_rows(all_predictions)

knitr::kable(head(final_predictions), caption = "Sample of Final Model Predictions")
```

## 5. Visualization

Finally, we use our plotting function to create the summary graphic showing the raw data points and the fitted model lines.

```{r visualize}
abundance_plot <- plot_abundance_trends(
  plot_data = analysis_data,
  predictions = final_predictions,
  species_map = species_list
)

print(abundance_plot)
```

## 6. Saving Outputs (Template)

The code below shows how you would save the final predictions table and the plot. In this vignette, these lines are commented out to prevent writing files during the documentation build. You can find the active, file-writing versions in the `_run_analysis.R` script.

```{r save_outputs, eval=FALSE}
# # Define output paths
# output_dir <- here("outputs_vignette")
# if (!dir.exists(output_dir)) dir.create(output_dir)
#
# # Save predictions to CSV
# write.csv(
#   final_predictions,
#   here(output_dir, "vignette_model_predictions.csv"),
#   row.names = FALSE
# )
#
# # Save plot to PNG
# ggsave(
#   filename = here(output_dir, "vignette_abundance_plot.png"),
#   plot = abundance_plot,
#   width = 8,
#   height = 6,
#   dpi = 100
# )

